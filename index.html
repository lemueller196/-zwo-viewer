<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ZWO Workout Viewer</title>
  <script src="https://js.live.net/v7.2/OneDrive.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    h1 { color: #005f73; }
    button, input[type="file"] { margin-top: 10px; }
    .file-entry {
      margin-top: 8px;
      cursor: pointer;
      color: #0056b3;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>ZWO Workout Viewer</h1>
  <p>Wähle lokale .zwo-Dateien oder lade aus OneDrive:</p>

  <input type="file" id="fileInput" accept=".zwo" multiple>
  <button id="onedriveBtn">Aus OneDrive-Ordner auswählen</button>

  <h2>Geladene Workouts</h2>
  <div id="fileList"></div>

  <script>
    const fileInput = document.getElementById("fileInput");
    const fileList = document.getElementById("fileList");

    // Lokale Dateien laden
    fileInput.addEventListener("change", (event) => {
      const files = event.target.files;
      for (const file of files) {
        const reader = new FileReader();
        reader.onload = (e) => showWorkout(file.name, e.target.result);
        reader.readAsText(file);
      }
    });

    // OneDrive Picker
    document.getElementById("onedriveBtn").addEventListener("click", () => {
      const odOptions = {
        clientId: "7b9ebc2b-3914-4d57-8948-dc44dac322a9",
        action: "download",
        multiSelect: true,
        advanced: {
          redirectUri: "https://lemueller196.github.io/-zwo-viewer/",
          queryParameters: {
            shareUrl: "https://bimanagementglw-my.sharepoint.com/:f:/g/personal/mueller_bimanagement_de/El2OBZhtQGREinDZ8hv9FEgBoMmoqVJdifbLqKPYiFntUQ?e=HpEfQ9"
          },
          filter: ".zwo"
        },
        success: async function (files) {
          for (const file of files.value) {
            const url = file["@microsoft.graph.downloadUrl"];
            const name = file.name;
            const resp = await fetch(url);
            const text = await resp.text();
            showWorkout(name, text);
          }
        },
        cancel: function () {
          console.log("Auswahl abgebrochen");
        },
        error: function (e) {
          console.error("OneDrive Fehler:", e);
          alert("Fehler beim Zugriff auf OneDrive: " + e.message);
        }
      };
      OneDrive.open(odOptions);
    });

    // Workout-Liste
    function showWorkout(name, xmlText) {
      const div = document.createElement("div");
      div.className = "file-entry";
      div.textContent = name;
      div.addEventListener("click", () => openWorkoutInNewTab(name, xmlText));
      fileList.appendChild(div);
    }

    // Neues Tab mit Workout anzeigen
    function openWorkoutInNewTab(name, xmlText) {
      const newWin = window.open();
      if (!newWin) {
        alert("Bitte Pop-ups für diese Seite erlauben!");
        return;
      }
      const html = `
        <!DOCTYPE html>
        <html lang="de">
        <head>
          <meta charset="UTF-8">
          <title>${name}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; background: #fff; }
            pre { white-space: pre-wrap; background: #f1f1f1; padding: 1em; border-radius: 5px; }
          </style>
        </head>
        <body>
          <h2>${name}</h2>
          <pre>${escapeHtml(xmlText)}</pre>
        </body>
        </html>`;
      newWin.document.write(html);
      newWin.document.close();
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }
  </script>
</body>
</html>
